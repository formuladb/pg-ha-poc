version: "3.9"  # optional since v1.27.0
services:
  monitor:
    image: citusdata/pg_auto_failover:demo
    environment:
      PGDATA: /tmp/pgaf
      PG_AUTOCTL_DEBUG: 1
    command: pg_autoctl create monitor --ssl-self-signed --auth trust --run
    expose:
      - 5432
  node1:
    image: citusdata/pg_auto_failover:demo
    environment:
      PGDATA: /tmp/pgaf
      PG_AUTOCTL_DEBUG: 1
    command: [
      "pg_autoctl", "create", "postgres",
      "--ssl-self-signed",
      "--auth", "trust",
      "--pg-hba-lan",
      "--username", "ad",
      "--dbname", "analytics",
      "--monitor", "postgresql://autoctl_node@monitor/pg_auto_failover",
      "--run"]
    expose:
      - 5432
  node2:
    image: citusdata/pg_auto_failover:demo
    environment:
      PGDATA: /tmp/pgaf
      PG_AUTOCTL_DEBUG: 1
    command: [
      "pg_autoctl", "create", "postgres",
      "--ssl-self-signed",
      "--auth", "trust",
      "--pg-hba-lan",
      "--username", "ad",
      "--dbname", "analytics",
      "--monitor", "postgresql://autoctl_node@monitor/pg_auto_failover",
      "--run"]
    expose:
      - 5432
  pgbouncer:
    image: edoburu/pgbouncer
    environment:
       - DB_USER=dbuser
       - DB_PASSWORD=hbZkzny5xrvVH
       - DB_HOST=node1,node2
       - DB_NAME=test
       - POOL_MODE=transaction
       - ADMIN_USERS=postgres,dbuser
    ports:
      - "5432:5432"
    depends_on:
      - node1
      - node2
  test:
    image: postgres
    environment:
      - POSTGRES_PASSWORD=postgres
    command: ["docker-entrypoint.sh", "-c", "log_statement=all"]
    depends_on:
      - pgbouncer
